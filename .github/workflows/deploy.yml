name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - claude/**  # Deploy on any claude/* branch
      - main
      - deploy

env:
  DEPLOY_USER: deploy-user
  WEB_ROOT: /var/www/traffic2u.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch and app name
        id: extract
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Extract app name from branch (e.g., claude/caption-generator-app-01xxx -> caption-generator)
          if [[ $BRANCH_NAME == claude/* ]]; then
            APP_NAME=$(echo $BRANCH_NAME | sed 's/claude\/\(.*\)-01.*/\1/')
          else
            APP_NAME=$(echo $BRANCH_NAME | tr '/' '-')
          fi
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "Deploying branch: $BRANCH_NAME"
          echo "App name: $APP_NAME"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create deployment directory on VPS
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new \
            ${{ env.DEPLOY_USER }}@${{ secrets.VPS_HOST }} \
            "mkdir -p ${WEB_ROOT}/${{ steps.extract.outputs.app_name }}"

      - name: Deploy application
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            ${{ env.DEPLOY_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY_SCRIPT'
            set -e

            APP_NAME="${{ steps.extract.outputs.app_name }}"
            BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"
            APP_DIR="${WEB_ROOT}/${APP_NAME}"

            echo "=========================================="
            echo "Deploying: $APP_NAME"
            echo "From Branch: $BRANCH_NAME"
            echo "To Directory: $APP_DIR"
            echo "=========================================="

            # Clone or update repository
            if [ -d "$APP_DIR/.git" ]; then
              echo "Repository exists, updating..."
              cd "$APP_DIR"
              git fetch origin
              git checkout $BRANCH_NAME
              git pull origin $BRANCH_NAME
            else
              echo "Cloning repository..."
              cd /tmp
              git clone --branch $BRANCH_NAME --single-branch \
                http://local_proxy@127.0.0.1:45069/git/kingdavsol/Traffic2umarketing.git \
                temp_deploy_$$
              cp -r temp_deploy_$$/* "$APP_DIR/"
              rm -rf temp_deploy_$$
              cd "$APP_DIR"
            fi

            # Check if package.json exists
            if [ -f "package.json" ]; then
              echo "Installing dependencies..."
              npm install --production

              # Check if build script exists
              if grep -q '"build"' package.json; then
                echo "Building application..."
                npm run build
              fi
            fi

            # Create .env from template if it doesn't exist
            if [ ! -f ".env" ] && [ -f ".env.example" ]; then
              echo "Creating .env from template..."
              cp .env.example .env
              echo "⚠️  Remember to configure .env with actual values!"
            fi

            # Determine port based on app type
            PORT=3000
            if grep -q '"next"' package.json 2>/dev/null; then
              PORT=3000
            elif grep -q '"react"' package.json 2>/dev/null; then
              if grep -q '"express"' package.json 2>/dev/null; then
                PORT=5000
              else
                PORT=3000
              fi
            else
              PORT=5000
            fi

            echo "Expected port: $PORT"

            DEPLOY_SCRIPT

      - name: Start application with PM2
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.DEPLOY_USER }}@${{ secrets.VPS_HOST }} << 'START_SCRIPT'
            set -e

            APP_NAME="${{ steps.extract.outputs.app_name }}"
            APP_DIR="${WEB_ROOT}/${APP_NAME}"

            cd "$APP_DIR"

            # Stop existing app if running
            pm2 stop "$APP_NAME" 2>/dev/null || true
            pm2 delete "$APP_NAME" 2>/dev/null || true

            # Start with PM2
            if [ -f "package.json" ]; then
              echo "Starting application with PM2..."

              # Check for custom start script
              if grep -q '"start"' package.json; then
                pm2 start "npm start" --name "$APP_NAME" --append-log
              else
                pm2 start "npm run dev" --name "$APP_NAME" --append-log 2>/dev/null || \
                pm2 start "node index.js" --name "$APP_NAME" --append-log 2>/dev/null || \
                pm2 start "node server.js" --name "$APP_NAME" --append-log
              fi

              # Save PM2 state
              pm2 save

              echo "Application started: $APP_NAME"
            fi

            START_SCRIPT

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ env.DEPLOY_USER }}@${{ secrets.VPS_HOST }} << 'VERIFY_SCRIPT'
            APP_NAME="${{ steps.extract.outputs.app_name }}"

            # Wait for app to start
            sleep 3

            # Check PM2 status
            echo "Application status:"
            pm2 list | grep "$APP_NAME" || echo "Warning: App not found in PM2 list"

            # Try to get health status
            STATUS=$(pm2 describe "$APP_NAME" 2>/dev/null | grep "status" | awk '{print $NF}' || echo "unknown")
            echo "Status: $STATUS"

            if [ "$STATUS" = "online" ]; then
              echo "✓ Deployment successful!"
            else
              echo "⚠️  App may not be running. Check logs:"
              pm2 logs "$APP_NAME" --lines 20
            fi

            VERIFY_SCRIPT

      - name: Display deployment summary
        if: always()
        run: |
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "App: ${{ steps.extract.outputs.app_name }}"
          echo "Branch: ${{ steps.extract.outputs.branch_name }}"
          echo "VPS: ${{ secrets.VPS_HOST }}"
          echo "Directory: ${WEB_ROOT}/${{ steps.extract.outputs.app_name }}"
          echo ""
          echo "Next Steps:"
          echo "1. Monitor app: pm2 logs ${{ steps.extract.outputs.app_name }}"
          echo "2. Configure .env with actual API keys, database URLs, etc."
          echo "3. Restart app: pm2 restart ${{ steps.extract.outputs.app_name }}"
          echo "4. Setup domain: ${{ steps.extract.outputs.app_name }}.traffic2u.com"
          echo "=========================================="

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✓ Deployment successful!"
            echo "App '${{ steps.extract.outputs.app_name }}' has been deployed to the VPS"
          else
            echo "✗ Deployment failed!"
            echo "Please check the logs above for details"
          fi

      - name: Upload logs as artifact (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ steps.extract.outputs.app_name }}
          path: |
            ~/.ssh/known_hosts
            /tmp/*.log
          retention-days: 7
>>>>>>> 8104ab69ba09380fd09628b5c2c03b7d267fdabb
